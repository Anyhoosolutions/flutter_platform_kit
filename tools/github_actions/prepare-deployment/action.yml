name: "Prepare Deployment"
description: "Comprehensive deployment preparation: verify version bump, decrypt SOPS secrets, load environment variables, generate release notes, update release_info.dart, set up Firebase CLI, build functions, set up Flutter, and run Flutter analyze"

inputs:
  # Version verification inputs
  verify_version:
    description: "Whether to verify version bump"
    required: false
    default: "true"
  version_file:
    description: "Path to the version file (e.g., pubspec.yaml)"
    required: false
    default: "pubspec.yaml"
  version_pattern:
    description: "Pattern to extract version (e.g., 'version:')"
    required: false
    default: "version:"
  version_override:
    description: "Optional version to override what's in pubspec.yaml (e.g., '1.2.3+456'). If provided, this version will be used instead of reading from the version file."
    required: false
    default: ""
  require_build_number_increase:
    description: "Whether to require build number (after +) to increase"
    required: false
    default: "true"
  fail_if_no_previous_version:
    description: "Whether to fail if no previous version is found"
    required: false
    default: "true"

  # SOPS decryption inputs
  decrypt_secrets:
    description: "Whether to decrypt SOPS secrets"
    required: false
    default: "true"
  sops_version:
    description: "SOPS version to install"
    required: false
    default: "v3.7.3"
  decrypt_script_url:
    description: "URL to the decrypt-secrets.sh script"
    required: false
    default: "https://raw.githubusercontent.com/Anyhoosolutions/flutter_platform_kit/main/tools/sops_secrets/decrypt-secrets.sh"
  verify_files:
    description: "Comma-separated list of files to verify exist after decryption"
    required: false
    default: ""
  sops_age_key:
    description: "SOPS AGE key for decrypting secrets"
    required: false
    default: ""

  # Environment loading inputs
  load_env:
    description: "Whether to load environment variables from .env"
    required: false
    default: "true"
  env_file:
    description: "Path to the .env file"
    required: false
    default: ".env"
  env_fail_if_missing:
    description: "Whether to fail if .env file is not found"
    required: false
    default: "true"

  # Release notes inputs
  generate_release_notes:
    description: "Whether to generate release notes"
    required: false
    default: "true"
  release_notes_output:
    description: "Path to output file for release notes"
    required: false
    default: "deploy/release_notes.txt"
  app_name:
    description: "Application name for release notes header"
    required: false
    default: ""
  commit_count:
    description: "Number of commits to include in release notes"
    required: false
    default: "10"

  # Release info inputs
  update_release_info:
    description: "Whether to update release_info.dart file"
    required: false
    default: "true"
  release_info_path:
    description: "Path to release_info.dart file"
    required: false
    default: "lib/features/about/release_info.dart"

  # Analysis options inputs
  update_analysis_options:
    description: "Whether to update analysis_options.yaml"
    required: false
    default: "false"
  analysis_options_ci_file:
    description: "Path to analysis_options.yaml-ci file"
    required: false
    default: "analysis_options.yaml-ci"

  # Firebase inputs
  setup_firebase:
    description: "Whether to set up Firebase CLI and test authentication"
    required: false
    default: "false"
  firebase_project_id:
    description: "Firebase project ID for authentication test"
    required: false
    default: ""
  firebase_service_account_path:
    description: "Path to Firebase service account JSON file"
    required: false
    default: "firebase_service_account.json"

  # Functions inputs
  build_functions:
    description: "Whether to install npm dependencies and build functions"
    required: false
    default: "false"
  functions_path:
    description: "Path to the functions directory"
    required: false
    default: "functions"
  functions_install_command:
    description: "Command to install npm dependencies"
    required: false
    default: "npm install"
  functions_build_command:
    description: "Command to build functions"
    required: false
    default: "npm run build"
  functions_chmod_biome:
    description: "Whether to chmod +x biome binary (for Linux x64)"
    required: false
    default: "false"

  # Flutter inputs
  setup_flutter:
    description: "Whether to set up Flutter"
    required: false
    default: "false"
  flutter_version:
    description: "Flutter version to use"
    required: false
    default: "3.38.4"
  flutter_channel:
    description: "Flutter channel to use"
    required: false
    default: "stable"
  flutter_analyze:
    description: "Whether to run Flutter analyze"
    required: false
    default: "false"

runs:
  using: "composite"
  steps:
    - name: Verify version was bumped
      shell: bash
      id: version-check
      if: inputs.verify_version == 'true'
      run: |
        echo ".."
        echo ".."
        echo ".."
        echo "===================================================="
        echo "====           VERIFY VERSION WAS BUMPED      ======"
        echo "===================================================="
        echo ".."
        echo ".."
        set -e  # Exit on any error

        VERSION_FILE="${{ inputs.version_file }}"
        VERSION_PATTERN="${{ inputs.version_pattern }}"
        VERSION_OVERRIDE="${{ inputs.version_override }}"

        # Get current version - use override if provided, otherwise read from file
        if [ -n "$VERSION_OVERRIDE" ]; then
          echo "üîß Using version override: $VERSION_OVERRIDE"
          current_version="$VERSION_OVERRIDE"
        else
          # Get current version from version file
          if [ ! -f "$VERSION_FILE" ]; then
            echo "‚ùå Error: Version file '$VERSION_FILE' not found"
            exit 1
          fi

          current_version=$(grep "$VERSION_PATTERN" "$VERSION_FILE" | sed "s/$VERSION_PATTERN//" | tr -d ' ' | head -n 1)
        fi

        echo "Current version: $current_version"
        echo "CURRENT_VERSION=$current_version" >> $GITHUB_ENV
        echo "current_version=$current_version" >> $GITHUB_OUTPUT

        # Get the previous version - compare against base branch for PRs, HEAD~1 for pushes
        echo "üîç Checking if version was changed..."

        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # For PRs, compare against the base branch
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          echo "üìã Comparing PR branch against base branch: $BASE_BRANCH"
          git fetch origin $BASE_BRANCH:$BASE_BRANCH || true
          if git rev-parse "$BASE_BRANCH" >/dev/null 2>&1; then
            previous_version=$(git show "$BASE_BRANCH:$VERSION_FILE" 2>/dev/null | grep "$VERSION_PATTERN" | sed "s/$VERSION_PATTERN//" | tr -d ' ' | head -n 1) || previous_version=""
          else
            previous_version=""
          fi
        else
          # For pushes, compare against HEAD~1
          echo "üìã Comparing against previous commit (HEAD~1)"
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            previous_version=$(git show HEAD~1:"$VERSION_FILE" 2>/dev/null | grep "$VERSION_PATTERN" | sed "s/$VERSION_PATTERN//" | tr -d ' ' | head -n 1) || previous_version=""
          else
            previous_version=""
          fi
        fi

        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "üìä Version Comparison:"
        echo "   Previous version:  $previous_version"
        echo "   Current version:   $current_version"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

        # If no previous version exists
        if [ -z "$previous_version" ]; then
          if [ "${{ inputs.fail_if_no_previous_version }}" = "true" ]; then
            echo ""
            echo "‚ùå ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚ùå NO PREVIOUS VERSION FOUND!"
            echo "‚ùå ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚ùå"
            echo "‚ùå This appears to be the first deployment or the previous"
            echo "‚ùå commit doesn't have a $VERSION_FILE file."
            echo "‚ùå"
            echo "‚ùå For safety, automated deployment requires a previous version"
            echo "‚ùå to compare against. Please deploy manually for the first time."
            echo "‚ùå"
            echo "‚ùå ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            exit 1
          else
            echo "‚ö†Ô∏è  No previous version found, but continuing anyway"
            echo "version_changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
        # Check if version changed
        elif [ "$current_version" = "$previous_version" ]; then
          echo ""
          echo "‚ùå ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚ùå VERSION CHECK FAILED!"
          echo "‚ùå ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚ùå"
          echo "‚ùå The version in $VERSION_FILE has NOT changed!"
          echo "‚ùå   Previous: $previous_version"
          echo "‚ùå   Current:  $current_version"
          echo "‚ùå"
          echo "‚ùå You must bump the version before deploying."
          echo "‚ùå"
          echo "‚ùå ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          exit 1
        else
          # Version changed - now verify it's actually higher if required
          if [ "${{ inputs.require_build_number_increase }}" = "true" ]; then
            # Extract build number (after +)
            current_version_code=$(echo "$current_version" | sed 's/.*+//')
            previous_version_code=$(echo "$previous_version" | sed 's/.*+//')

            echo ""
            echo "‚úÖ Version changed detected!"
            echo "   Version code: $previous_version_code ‚Üí $current_version_code"

            # Verify the build number increased
            if [ -z "$current_version_code" ] || [ -z "$previous_version_code" ]; then
              echo ""
              echo "‚ö†Ô∏è  Warning: Could not extract build numbers from versions"
              echo "   Previous: $previous_version"
              echo "   Current:  $current_version"
              echo "   Build numbers should be after '+' (e.g., 1.0.0+123)"
            elif [ "$current_version_code" -le "$previous_version_code" ]; then
              echo ""
              echo "‚ùå ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "‚ùå VERSION CODE NOT HIGHER!"
              echo "‚ùå ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "‚ùå"
              echo "‚ùå Version changed but build number is NOT higher:"
              echo "‚ùå   Previous: $previous_version (code: $previous_version_code)"
              echo "‚ùå   Current:  $current_version (code: $current_version_code)"
              echo "‚ùå"
              echo "‚ùå Build number must increase (the number after +)"
              echo "‚ùå"
              echo "‚ùå ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              exit 1
            else
              echo ""
              echo "‚úÖ ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "‚úÖ VERSION CHECK PASSED!"
              echo "‚úÖ ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "‚úÖ Version bumped: $previous_version ‚Üí $current_version"
              echo "‚úÖ Build number increased: $previous_version_code ‚Üí $current_version_code"
              echo "‚úÖ Proceeding with deployment..."
              echo "‚úÖ ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo ""
              echo "version_changed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo ""
            echo "‚úÖ Version changed: $previous_version ‚Üí $current_version"
            echo "version_changed=true" >> $GITHUB_OUTPUT
          fi
        fi

    - name: Install SOPS
      shell: bash
      if: inputs.decrypt_secrets == 'true'
      run: |
        echo ".."
        echo ".."
        echo ".."
        echo "===================================================="
        echo "====             INSTALL SOPS                 ======"
        echo "===================================================="
        echo ".."
        echo ".."
        echo "üì¶ Installing SOPS ${{ inputs.sops_version }}..."
        wget -O sops https://github.com/mozilla/sops/releases/download/${{ inputs.sops_version }}/sops-${{ inputs.sops_version }}.linux
        chmod +x sops
        sudo mv sops /usr/local/bin/
        echo "‚úÖ SOPS installed"
        sops --version

    - name: Decrypt secrets with SOPS
      shell: bash
      if: inputs.decrypt_secrets == 'true'
      env:
        SOPS_AGE_KEY: ${{ inputs.sops_age_key }}
      run: |
        echo ".."
        echo ".."
        echo ".."
        echo "===================================================="
        echo "====          DECRYPT SECRETS WITH SOPS       ======"
        echo "===================================================="
        echo ".."
        echo ".."
        echo "üîì Decrypting secrets with SOPS..."
        echo "SOPS_AGE_KEY: ${SOPS_AGE_KEY:0:5}"
        curl -sSL "${{ inputs.decrypt_script_url }}" | bash
        echo "‚úÖ Secrets decrypted"

    - name: Verify decrypted files
      shell: bash
      if: inputs.decrypt_secrets == 'true' && inputs.verify_files != ''
      run: |
        echo ".."
        echo ".."
        echo ".."
        echo "===================================================="
        echo "====         VERIFY DECRYPTED FILES           ======"
        echo "===================================================="
        echo ".."
        echo ".."
        echo "üîç Verifying decrypted files..."
        IFS=',' read -ra FILES <<< "${{ inputs.verify_files }}"
        FAILED=0

        for file in "${FILES[@]}"; do
          file=$(echo "$file" | xargs)  # Trim whitespace
          if [ -f "$file" ]; then
            echo "‚úÖ $file exists ($(wc -c < "$file") bytes)"

            # If it's a JSON file, verify it's valid JSON
            if [[ "$file" == *.json ]]; then
              if python3 -m json.tool "$file" > /dev/null 2>&1; then
                echo "‚úÖ $file is valid JSON"
              else
                echo "‚ùå $file is not valid JSON"
                FAILED=1
              fi
            fi
          else
            echo "‚ùå $file not found"
            FAILED=1
          fi
        done

        if [ $FAILED -eq 1 ]; then
          echo "‚ùå Some required files are missing or invalid"
          exit 1
        fi

        echo "‚úÖ All required files verified"

    - name: Load environment variables from .env
      shell: bash
      if: inputs.load_env == 'true'
      run: |
        echo ".."
        echo ".."
        echo ".."
        echo "====================================================="
        echo "====    LOAD ENVIRONMENT VARIABLES FROM .ENV   ======"
        echo "====================================================="
        echo ".."
        echo ".."
        ENV_FILE="${{ inputs.env_file }}"

        echo "üîç Loading environment variables from $ENV_FILE file..."

        if [ -f "$ENV_FILE" ]; then
          echo "‚úÖ $ENV_FILE file exists"
          echo "üìè File size: $(wc -c < "$ENV_FILE") bytes"
          echo "üìã Variables found in $ENV_FILE (names only):"
          grep -v '^#' "$ENV_FILE" | grep '=' | cut -d'=' -f1 || echo "No variables found"

          # Load variables into GitHub Environment
          while IFS='=' read -r key value; do
            # Skip comments and empty lines
            if [[ ! "$key" =~ ^# ]] && [[ -n "$key" ]]; then
              # Remove quotes from value if present
              value=$(echo "$value" | sed 's/^"//; s/"$//')
              echo "$key=$value" >> $GITHUB_ENV
              echo "‚úÖ Loaded: $key"
            fi
          done < "$ENV_FILE"

          echo "‚úÖ Environment variables loaded successfully"
        else
          if [ "${{ inputs.env_fail_if_missing }}" = "true" ]; then
            echo "‚ùå $ENV_FILE file not found!"
            ls -la | grep env || echo "No .env files in directory"
            exit 1
          else
            echo "‚ö†Ô∏è  $ENV_FILE file not found, but continuing anyway"
          fi
        fi

    - name: Generate release notes
      shell: bash
      if: inputs.generate_release_notes == 'true'
      run: |
        echo ".."
        echo ".."
        echo ".."
        echo "===================================================="
        echo "====          GENERATE RELEASE NOTES          ======"
        echo "===================================================="
        echo ".."
        echo ".."
        OUTPUT_FILE="${{ inputs.release_notes_output }}"
        APP_NAME="${{ inputs.app_name }}"
        VERSION="${{ inputs.version }}"
        COMMIT_COUNT="${{ inputs.commit_count }}"

        # Use version from env if not provided
        if [ -z "$VERSION" ] && [ -n "$CURRENT_VERSION" ]; then
          VERSION="$CURRENT_VERSION"
        fi

        echo "üîç Generating release notes..."

        # Create output directory if it doesn't exist
        OUTPUT_DIR=$(dirname "$OUTPUT_FILE")
        if [ ! -d "$OUTPUT_DIR" ]; then
          mkdir -p "$OUTPUT_DIR"
        fi

        # Get commit messages since last merge to main
        COMMIT_MESSAGES=$(git log --oneline --no-merges -$COMMIT_COUNT | head -$COMMIT_COUNT)

        # Use GitHub's context variables for accurate commit info
        # For PRs, use the head commit; for pushes, use github.sha
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          COMMIT_HASH="${{ github.event.pull_request.head.sha }}"
          CURRENT_BRANCH="${{ github.event.pull_request.head.ref }}"
        else
          COMMIT_HASH="${{ github.sha }}"
          CURRENT_BRANCH="${{ github.ref_name }}"
        fi
        COMMIT_HASH_SHORT="${COMMIT_HASH:0:7}"

        # Build header
        if [ -n "$APP_NAME" ]; then
          HEADER="$APP_NAME - Release $VERSION"
        else
          HEADER="Release $VERSION"
        fi

        # Create release notes file
        cat > "$OUTPUT_FILE" << EOF
        $HEADER
        Build: #${{ github.run_number }}
        Branch: ${CURRENT_BRANCH}
        Commit: ${COMMIT_HASH_SHORT}

        Changes in this release:
        ${COMMIT_MESSAGES}

        Deployed on: $(date '+%Y-%m-%d %H:%M:%S')
        EOF

        echo "üìù Release notes:"
        cat "$OUTPUT_FILE"
        echo "‚úÖ Release notes generated and saved to $OUTPUT_FILE"

        # Set output for the file path
        echo "release_notes_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT

    - name: Update release_info.dart
      shell: bash
      if: inputs.update_release_info == 'true'
      run: |
        echo ".."
        echo ".."
        echo ".."
        echo "===================================================="
        echo "====          UPDATE RELEASE_INFO.DART        ======"
        echo "===================================================="
        echo ".."
        echo ".."
        RELEASE_INFO_PATH="${{ inputs.release_info_path }}"
        VERSION=""

        # Use version from env if not provided
        if [ -n "$CURRENT_VERSION" ]; then
          VERSION="$CURRENT_VERSION"
        fi

        if [ -z "$VERSION" ]; then
          echo "‚ùå Version not provided and CURRENT_VERSION not set"
          exit 1
        fi

        echo "üîç Updating $RELEASE_INFO_PATH with build information..."

        # Check if file exists
        if [ ! -f "$RELEASE_INFO_PATH" ]; then
          echo "‚ùå File not found: $RELEASE_INFO_PATH"
          exit 1
        fi
        cat "$RELEASE_INFO_PATH"

        # Set variables from GitHub context
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          COMMIT_HASH="${{ github.event.pull_request.head.sha }}"
          CURRENT_BRANCH="${{ github.event.pull_request.head.ref }}"
        else
          COMMIT_HASH="${{ github.sha }}"
          CURRENT_BRANCH="${{ github.ref_name }}"
        fi
        COMMIT_HASH_SHORT="${COMMIT_HASH:0:7}"
        BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')

        # Update release_info.dart file
        sed -i "s/final String version = '.*';/final String version = '$VERSION';/" "$RELEASE_INFO_PATH"
        sed -i "s/final String buildDate = '.*';/final String buildDate = '${BUILD_DATE}';/" "$RELEASE_INFO_PATH"
        sed -i "s/final String commitHash = '.*';/final String commitHash = '${COMMIT_HASH}';/" "$RELEASE_INFO_PATH"
        sed -i "s/final String branch = '.*';/final String branch = '${CURRENT_BRANCH}';/" "$RELEASE_INFO_PATH"
        sed -i "s/final String commitHashShort = '.*';/final String commitHashShort = '${COMMIT_HASH_SHORT}';/" "$RELEASE_INFO_PATH"

        echo "‚úÖ Updated $RELEASE_INFO_PATH:"
        cat "$RELEASE_INFO_PATH"

    - name: Update analysis options.yaml
      shell: bash
      if: inputs.update_analysis_options == 'true'
      run: |
        echo ".."
        echo ".."
        echo ".."
        echo "===================================================="
        echo "====         UPDATE ANALYSIS_OPTIONS.YAML     ======"
        echo "===================================================="
        echo ".."
        echo ".."
        set -e
        CI_FILE="${{ inputs.analysis_options_ci_file }}"
        TARGET_FILE="analysis_options.yaml"

        echo "üîç Updating analysis_options.yaml..."
        if [ ! -f "$CI_FILE" ]; then
          echo "‚ùå Error: $CI_FILE not found"
          exit 1
        fi

        mv "$CI_FILE" "$TARGET_FILE"
        echo "‚úÖ Updated $TARGET_FILE from $CI_FILE"

    - name: Install Firebase CLI
      shell: bash
      if: inputs.setup_firebase == 'true'
      run: |
        echo ".."
        echo ".."
        echo ".."
        echo "===================================================="
        echo "====         INSTALL FIREBASE CLI             ======"
        echo "===================================================="
        echo ".."
        echo ".."
        set -e
        echo "üì¶ Installing Firebase CLI..."
        npm install -g firebase-tools
        echo "‚úÖ Firebase CLI installed: $(firebase --version)"

    - name: Test Firebase service account authentication
      shell: bash
      if: inputs.setup_firebase == 'true' && inputs.firebase_project_id != ''
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/${{ inputs.firebase_service_account_path }}
      run: |
        echo ".."
        echo ".."
        echo ".."
        echo "=============================================================="
        echo "====     TEST FIREBASE SERVICE ACCOUNT AUTHENTICATION   ======"
        echo "=============================================================="
        echo ".."
        echo ".."
        set -e
        echo "üîç Testing Firebase service account authentication..."
        echo "üìã Service account file: $GOOGLE_APPLICATION_CREDENTIALS"

        # Test authentication by listing projects (lightweight operation)
        if firebase projects:list --project ${{ inputs.firebase_project_id }} > /dev/null 2>&1; then
          echo "‚úÖ Firebase authentication successful!"
          echo "‚úÖ Service account has access to project: ${{ inputs.firebase_project_id }}"
        else
          echo "‚ùå Firebase authentication failed!"
          echo "‚ùå Service account may not have proper permissions"
          echo "‚ùå Please verify the service account has the following roles:"
          echo "   - Firebase Admin (or Firebase Admin SDK Administrator Service Agent)"
          echo "   - Service Account Admin"
          echo "   - Service Usage Admin"
          exit 1
        fi

    - name: Install npm dependencies and build functions
      shell: bash
      if: inputs.build_functions == 'true'
      run: |
        echo ".."
        echo ".."
        echo ".."
        echo "============================================================"
        echo "====    INSTALL NPM DEPENDENCIES AND BUILD FUNCTIONS  ======"
        echo "============================================================"
        echo ".."
        echo ".."
        set -e
        FUNCTIONS_PATH="${{ inputs.functions_path }}"
        echo "üì¶ Installing npm dependencies and building functions in $FUNCTIONS_PATH..."

        if [ ! -d "$FUNCTIONS_PATH" ]; then
          echo "‚ùå Error: Functions directory '$FUNCTIONS_PATH' not found"
          exit 1
        fi

        cd "$FUNCTIONS_PATH"
        echo "Running install command: ${{ inputs.functions_install_command }}"
        ${{ inputs.functions_install_command }}

        if [ "${{ inputs.functions_chmod_biome }}" = "true" ]; then
          echo "üîß Setting executable permissions for biome..."
          if [ -f "node_modules/@biomejs/cli-linux-x64/biome" ]; then
            chmod +x node_modules/@biomejs/cli-linux-x64/biome
            echo "‚úÖ Biome binary permissions set"
          else
            echo "‚ö†Ô∏è  Warning: Biome binary not found at expected path"
          fi
        fi

        echo "Running build command: ${{ inputs.functions_build_command }}"
        ${{ inputs.functions_build_command }}
        echo "‚úÖ Functions built successfully"

    - name: Set up Flutter
      if: inputs.setup_flutter == 'true'
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ inputs.flutter_version }}
        channel: ${{ inputs.flutter_channel }}

    - name: Show Flutter version
      shell: bash
      if: inputs.setup_flutter == 'true'
      run: |
        echo ".."
        echo ".."
        echo ".."
        echo "===================================================="
        echo "====              SHOW FLUTTER VERSION        ======"
        echo "===================================================="
        echo ".."
        echo ".."
        set -e
        echo "üì± Flutter version:"
        flutter --version

    - name: Cache Flutter dependencies
      if: inputs.setup_flutter == 'true'
      uses: actions/cache@v3
      with:
        path: |
          .pub-cache/bin
          .pub-cache/global_packages
          .pub-cache/hosted
          .dart_tool
          .packages
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}

    - name: Get Flutter dependencies
      shell: bash
      if: inputs.setup_flutter == 'true'
      run: |
        echo ".."
        echo ".."
        echo ".."
        echo "===================================================="
        echo "====            GET FLUTTER DEPENDENCIES      ======"
        echo "===================================================="
        echo ".."
        echo ".."
        set -e
        echo "üì¶ Getting Flutter dependencies..."
        flutter pub get
        echo "‚úÖ Flutter dependencies installed"

    - name: Flutter analyze
      shell: bash
      if: inputs.setup_flutter == 'true' && inputs.flutter_analyze == 'true'
      run: |
        echo ".."
        echo ".."
        echo ".."
        echo "===================================================="
        echo "====             RUN FLUTTER ANALYZE          ======"
        echo "===================================================="
        echo ".."
        echo ".."
        set -e
        echo "üîç Running Flutter analyze..."
        flutter analyze
        echo "‚úÖ Flutter analyze completed"
