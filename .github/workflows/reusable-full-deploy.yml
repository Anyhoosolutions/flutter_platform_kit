name: Reusable Full Deploy

on:
  workflow_call:
    inputs:
      # ==================== CHECKOUT OPTIONS ====================
      commit_sha:
        description: "Specific commit SHA to deploy (leave empty for branch HEAD)"
        required: false
        type: string
        default: ""

      # ==================== BUILD CONFIGURATION ====================
      version:
        description: "Version Name (e.g., 1.0.2+123)"
        required: true
        type: string
      release_notes:
        description: "Release Notes"
        required: false
        type: string
        default: "Manual build from GitHub Actions"

      # ==================== ANDROID DEPLOYMENTS ====================
      android_flavor1:
        description: "Deploy Android - Flavor 1"
        required: false
        type: boolean
        default: false
      android_flavor2:
        description: "Deploy Android - Flavor 2"
        required: false
        type: boolean
        default: false
      android_flavor3:
        description: "Deploy Android - Flavor 3"
        required: false
        type: boolean
        default: false
      android_flavor4:
        description: "Deploy Android - Flavor 4"
        required: false
        type: boolean
        default: false
      android_flavor5:
        description: "Deploy Android - Flavor 5"
        required: false
        type: boolean
        default: false

      # ==================== iOS DEPLOYMENTS ====================
      ios_flavor1:
        description: "Deploy iOS - Flavor 1"
        required: false
        type: boolean
        default: false
      ios_flavor2:
        description: "Deploy iOS - Flavor 2"
        required: false
        type: boolean
        default: false
      ios_flavor3:
        description: "Deploy iOS - Flavor 3"
        required: false
        type: boolean
        default: false
      ios_flavor4:
        description: "Deploy iOS - Flavor 4"
        required: false
        type: boolean
        default: false
      ios_flavor5:
        description: "Deploy iOS - Flavor 5"
        required: false
        type: boolean
        default: false

      # ==================== WEB DEPLOYMENTS ====================
      web_flavor1:
        description: "Deploy Web - Flavor 1"
        required: false
        type: boolean
        default: false
      web_flavor2:
        description: "Deploy Web - Flavor 2"
        required: false
        type: boolean
        default: false
      web_flavor3:
        description: "Deploy Web - Flavor 3"
        required: false
        type: boolean
        default: false
      web_flavor4:
        description: "Deploy Web - Flavor 4"
        required: false
        type: boolean
        default: false
      web_flavor5:
        description: "Deploy Web - Flavor 5"
        required: false
        type: boolean
        default: false

      # ==================== OTHER DEPLOYMENTS ====================
      functions:
        description: "Deploy Firebase Functions"
        required: false
        type: boolean
        default: false
      widgetbook:
        description: "Deploy Widgetbook"
        required: false
        type: boolean
        default: false

    secrets:
      SOPS_AGE_KEY:
        required: true

# Ensure only one deployment runs at a time per repo
concurrency:
  group: deploy-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================================
  # PREPARE JOB - Runs once, validates inputs, computes matrices
  # ============================================================================
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      # Flavor arrays for matrix strategies
      android_flavors: ${{ steps.compute-matrices.outputs.android_flavors }}
      ios_flavors: ${{ steps.compute-matrices.outputs.ios_flavors }}
      web_flavors: ${{ steps.compute-matrices.outputs.web_flavors }}
      # Boolean flags for job conditions
      has_android: ${{ steps.compute-matrices.outputs.has_android }}
      has_ios: ${{ steps.compute-matrices.outputs.has_ios }}
      has_web: ${{ steps.compute-matrices.outputs.has_web }}
      has_functions: ${{ steps.compute-matrices.outputs.has_functions }}
      has_widgetbook: ${{ steps.compute-matrices.outputs.has_widgetbook }}
      # Checkout ref
      checkout_ref: ${{ steps.determine-ref.outputs.checkout_ref }}
      # Config values
      flutter_version: ${{ steps.load-config.outputs.flutter_version }}
      flutter_channel: ${{ steps.load-config.outputs.flutter_channel }}
      firebase_project: ${{ steps.load-config.outputs.firebase_project }}
      service_account: ${{ steps.load-config.outputs.service_account }}
      functions_path: ${{ steps.load-config.outputs.functions_path }}

    steps:
      - name: Determine checkout ref
        id: determine-ref
        run: |
          if [ -n "${{ inputs.commit_sha }}" ]; then
            echo "checkout_ref=${{ inputs.commit_sha }}" >> $GITHUB_OUTPUT
            echo "ðŸ“Œ Will checkout specific commit: ${{ inputs.commit_sha }}"
          else
            echo "checkout_ref=${{ github.ref }}" >> $GITHUB_OUTPUT
            echo "ðŸ“Œ Will checkout branch: ${{ github.ref }}"
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.determine-ref.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Debug - Print workflow inputs
        run: |
          echo "===================================================="
          echo "====           WORKFLOW INPUTS                 ======"
          echo "===================================================="
          echo ""
          echo "Checkout:"
          echo "  commit_sha: ${{ inputs.commit_sha }}"
          echo "  resolved ref: ${{ steps.determine-ref.outputs.checkout_ref }}"
          echo ""
          echo "Build Configuration:"
          echo "  version: ${{ inputs.version }}"
          echo "  release_notes: ${{ inputs.release_notes }}"
          echo ""
          echo "Android Deployments:"
          echo "  flavor1: ${{ inputs.android_flavor1 }}"
          echo "  flavor2: ${{ inputs.android_flavor2 }}"
          echo "  flavor3: ${{ inputs.android_flavor3 }}"
          echo "  flavor4: ${{ inputs.android_flavor4 }}"
          echo "  flavor5: ${{ inputs.android_flavor5 }}"
          echo ""
          echo "iOS Deployments:"
          echo "  flavor1: ${{ inputs.ios_flavor1 }}"
          echo "  flavor2: ${{ inputs.ios_flavor2 }}"
          echo "  flavor3: ${{ inputs.ios_flavor3 }}"
          echo "  flavor4: ${{ inputs.ios_flavor4 }}"
          echo "  flavor5: ${{ inputs.ios_flavor5 }}"
          echo ""
          echo "Web Deployments:"
          echo "  flavor1: ${{ inputs.web_flavor1 }}"
          echo "  flavor2: ${{ inputs.web_flavor2 }}"
          echo "  flavor3: ${{ inputs.web_flavor3 }}"
          echo "  flavor4: ${{ inputs.web_flavor4 }}"
          echo "  flavor5: ${{ inputs.web_flavor5 }}"
          echo ""
          echo "Other Deployments:"
          echo "  functions: ${{ inputs.functions }}"
          echo "  widgetbook: ${{ inputs.widgetbook }}"
          echo "===================================================="

      - name: Load deploy configuration
        id: load-config
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/load-deploy-config@main

      - name: Compute deployment matrices
        id: compute-matrices
        run: |
          echo "ðŸ” Computing deployment matrices..."

          CONFIG_FILE=".github/deploy-config.json"

          # Build Android matrix
          ANDROID_FLAVORS="["
          ANDROID_COUNT=0

          if [ "${{ inputs.android_flavor1 }}" = "true" ]; then
            FLAVOR_NAME=$(jq -r '.flavor_mapping.flavor1 // empty' "$CONFIG_FILE")
            if [ -n "$FLAVOR_NAME" ]; then
              [ $ANDROID_COUNT -gt 0 ] && ANDROID_FLAVORS="${ANDROID_FLAVORS},"
              ANDROID_FLAVORS="${ANDROID_FLAVORS}{\"slot\":\"flavor1\",\"name\":\"$FLAVOR_NAME\"}"
              ANDROID_COUNT=$((ANDROID_COUNT + 1))
            fi
          fi
          if [ "${{ inputs.android_flavor2 }}" = "true" ]; then
            FLAVOR_NAME=$(jq -r '.flavor_mapping.flavor2 // empty' "$CONFIG_FILE")
            if [ -n "$FLAVOR_NAME" ]; then
              [ $ANDROID_COUNT -gt 0 ] && ANDROID_FLAVORS="${ANDROID_FLAVORS},"
              ANDROID_FLAVORS="${ANDROID_FLAVORS}{\"slot\":\"flavor2\",\"name\":\"$FLAVOR_NAME\"}"
              ANDROID_COUNT=$((ANDROID_COUNT + 1))
            fi
          fi
          if [ "${{ inputs.android_flavor3 }}" = "true" ]; then
            FLAVOR_NAME=$(jq -r '.flavor_mapping.flavor3 // empty' "$CONFIG_FILE")
            if [ -n "$FLAVOR_NAME" ]; then
              [ $ANDROID_COUNT -gt 0 ] && ANDROID_FLAVORS="${ANDROID_FLAVORS},"
              ANDROID_FLAVORS="${ANDROID_FLAVORS}{\"slot\":\"flavor3\",\"name\":\"$FLAVOR_NAME\"}"
              ANDROID_COUNT=$((ANDROID_COUNT + 1))
            fi
          fi
          if [ "${{ inputs.android_flavor4 }}" = "true" ]; then
            FLAVOR_NAME=$(jq -r '.flavor_mapping.flavor4 // empty' "$CONFIG_FILE")
            if [ -n "$FLAVOR_NAME" ]; then
              [ $ANDROID_COUNT -gt 0 ] && ANDROID_FLAVORS="${ANDROID_FLAVORS},"
              ANDROID_FLAVORS="${ANDROID_FLAVORS}{\"slot\":\"flavor4\",\"name\":\"$FLAVOR_NAME\"}"
              ANDROID_COUNT=$((ANDROID_COUNT + 1))
            fi
          fi
          if [ "${{ inputs.android_flavor5 }}" = "true" ]; then
            FLAVOR_NAME=$(jq -r '.flavor_mapping.flavor5 // empty' "$CONFIG_FILE")
            if [ -n "$FLAVOR_NAME" ]; then
              [ $ANDROID_COUNT -gt 0 ] && ANDROID_FLAVORS="${ANDROID_FLAVORS},"
              ANDROID_FLAVORS="${ANDROID_FLAVORS}{\"slot\":\"flavor5\",\"name\":\"$FLAVOR_NAME\"}"
              ANDROID_COUNT=$((ANDROID_COUNT + 1))
            fi
          fi
          ANDROID_FLAVORS="${ANDROID_FLAVORS}]"

          # Build iOS matrix
          IOS_FLAVORS="["
          IOS_COUNT=0

          if [ "${{ inputs.ios_flavor1 }}" = "true" ]; then
            FLAVOR_NAME=$(jq -r '.flavor_mapping.flavor1 // empty' "$CONFIG_FILE")
            if [ -n "$FLAVOR_NAME" ]; then
              [ $IOS_COUNT -gt 0 ] && IOS_FLAVORS="${IOS_FLAVORS},"
              IOS_FLAVORS="${IOS_FLAVORS}{\"slot\":\"flavor1\",\"name\":\"$FLAVOR_NAME\"}"
              IOS_COUNT=$((IOS_COUNT + 1))
            fi
          fi
          if [ "${{ inputs.ios_flavor2 }}" = "true" ]; then
            FLAVOR_NAME=$(jq -r '.flavor_mapping.flavor2 // empty' "$CONFIG_FILE")
            if [ -n "$FLAVOR_NAME" ]; then
              [ $IOS_COUNT -gt 0 ] && IOS_FLAVORS="${IOS_FLAVORS},"
              IOS_FLAVORS="${IOS_FLAVORS}{\"slot\":\"flavor2\",\"name\":\"$FLAVOR_NAME\"}"
              IOS_COUNT=$((IOS_COUNT + 1))
            fi
          fi
          if [ "${{ inputs.ios_flavor3 }}" = "true" ]; then
            FLAVOR_NAME=$(jq -r '.flavor_mapping.flavor3 // empty' "$CONFIG_FILE")
            if [ -n "$FLAVOR_NAME" ]; then
              [ $IOS_COUNT -gt 0 ] && IOS_FLAVORS="${IOS_FLAVORS},"
              IOS_FLAVORS="${IOS_FLAVORS}{\"slot\":\"flavor3\",\"name\":\"$FLAVOR_NAME\"}"
              IOS_COUNT=$((IOS_COUNT + 1))
            fi
          fi
          if [ "${{ inputs.ios_flavor4 }}" = "true" ]; then
            FLAVOR_NAME=$(jq -r '.flavor_mapping.flavor4 // empty' "$CONFIG_FILE")
            if [ -n "$FLAVOR_NAME" ]; then
              [ $IOS_COUNT -gt 0 ] && IOS_FLAVORS="${IOS_FLAVORS},"
              IOS_FLAVORS="${IOS_FLAVORS}{\"slot\":\"flavor4\",\"name\":\"$FLAVOR_NAME\"}"
              IOS_COUNT=$((IOS_COUNT + 1))
            fi
          fi
          if [ "${{ inputs.ios_flavor5 }}" = "true" ]; then
            FLAVOR_NAME=$(jq -r '.flavor_mapping.flavor5 // empty' "$CONFIG_FILE")
            if [ -n "$FLAVOR_NAME" ]; then
              [ $IOS_COUNT -gt 0 ] && IOS_FLAVORS="${IOS_FLAVORS},"
              IOS_FLAVORS="${IOS_FLAVORS}{\"slot\":\"flavor5\",\"name\":\"$FLAVOR_NAME\"}"
              IOS_COUNT=$((IOS_COUNT + 1))
            fi
          fi
          IOS_FLAVORS="${IOS_FLAVORS}]"

          # Build Web matrix
          WEB_FLAVORS="["
          WEB_COUNT=0

          if [ "${{ inputs.web_flavor1 }}" = "true" ]; then
            FLAVOR_NAME=$(jq -r '.flavor_mapping.flavor1 // empty' "$CONFIG_FILE")
            if [ -n "$FLAVOR_NAME" ]; then
              [ $WEB_COUNT -gt 0 ] && WEB_FLAVORS="${WEB_FLAVORS},"
              WEB_FLAVORS="${WEB_FLAVORS}{\"slot\":\"flavor1\",\"name\":\"$FLAVOR_NAME\"}"
              WEB_COUNT=$((WEB_COUNT + 1))
            fi
          fi
          if [ "${{ inputs.web_flavor2 }}" = "true" ]; then
            FLAVOR_NAME=$(jq -r '.flavor_mapping.flavor2 // empty' "$CONFIG_FILE")
            if [ -n "$FLAVOR_NAME" ]; then
              [ $WEB_COUNT -gt 0 ] && WEB_FLAVORS="${WEB_FLAVORS},"
              WEB_FLAVORS="${WEB_FLAVORS}{\"slot\":\"flavor2\",\"name\":\"$FLAVOR_NAME\"}"
              WEB_COUNT=$((WEB_COUNT + 1))
            fi
          fi
          if [ "${{ inputs.web_flavor3 }}" = "true" ]; then
            FLAVOR_NAME=$(jq -r '.flavor_mapping.flavor3 // empty' "$CONFIG_FILE")
            if [ -n "$FLAVOR_NAME" ]; then
              [ $WEB_COUNT -gt 0 ] && WEB_FLAVORS="${WEB_FLAVORS},"
              WEB_FLAVORS="${WEB_FLAVORS}{\"slot\":\"flavor3\",\"name\":\"$FLAVOR_NAME\"}"
              WEB_COUNT=$((WEB_COUNT + 1))
            fi
          fi
          if [ "${{ inputs.web_flavor4 }}" = "true" ]; then
            FLAVOR_NAME=$(jq -r '.flavor_mapping.flavor4 // empty' "$CONFIG_FILE")
            if [ -n "$FLAVOR_NAME" ]; then
              [ $WEB_COUNT -gt 0 ] && WEB_FLAVORS="${WEB_FLAVORS},"
              WEB_FLAVORS="${WEB_FLAVORS}{\"slot\":\"flavor4\",\"name\":\"$FLAVOR_NAME\"}"
              WEB_COUNT=$((WEB_COUNT + 1))
            fi
          fi
          if [ "${{ inputs.web_flavor5 }}" = "true" ]; then
            FLAVOR_NAME=$(jq -r '.flavor_mapping.flavor5 // empty' "$CONFIG_FILE")
            if [ -n "$FLAVOR_NAME" ]; then
              [ $WEB_COUNT -gt 0 ] && WEB_FLAVORS="${WEB_FLAVORS},"
              WEB_FLAVORS="${WEB_FLAVORS}{\"slot\":\"flavor5\",\"name\":\"$FLAVOR_NAME\"}"
              WEB_COUNT=$((WEB_COUNT + 1))
            fi
          fi
          WEB_FLAVORS="${WEB_FLAVORS}]"

          # Set outputs
          echo "android_flavors=$ANDROID_FLAVORS" >> $GITHUB_OUTPUT
          echo "ios_flavors=$IOS_FLAVORS" >> $GITHUB_OUTPUT
          echo "web_flavors=$WEB_FLAVORS" >> $GITHUB_OUTPUT

          echo "has_android=$( [ $ANDROID_COUNT -gt 0 ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          echo "has_ios=$( [ $IOS_COUNT -gt 0 ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          echo "has_web=$( [ $WEB_COUNT -gt 0 ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          echo "has_functions=${{ inputs.functions }}" >> $GITHUB_OUTPUT
          echo "has_widgetbook=${{ inputs.widgetbook }}" >> $GITHUB_OUTPUT

          echo ""
          echo "ðŸ“‹ Computed matrices:"
          echo "  Android: $ANDROID_FLAVORS (count: $ANDROID_COUNT)"
          echo "  iOS: $IOS_FLAVORS (count: $IOS_COUNT)"
          echo "  Web: $WEB_FLAVORS (count: $WEB_COUNT)"
          echo "  Functions: ${{ inputs.functions }}"
          echo "  Widgetbook: ${{ inputs.widgetbook }}"

      - name: Check SOPS key availability
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          echo "ðŸ” Checking SOPS_AGE_KEY..."
          if [ -z "$SOPS_AGE_KEY" ]; then
            echo "âŒ SOPS_AGE_KEY is empty or not set"
            exit 1
          else
            echo "âœ… SOPS_AGE_KEY is set (length: ${#SOPS_AGE_KEY} chars)"
          fi

      - name: Verify at least one deployment is selected
        run: |
          if [ "${{ inputs.android_flavor1 }}" != "true" ] && \
             [ "${{ inputs.android_flavor2 }}" != "true" ] && \
             [ "${{ inputs.android_flavor3 }}" != "true" ] && \
             [ "${{ inputs.android_flavor4 }}" != "true" ] && \
             [ "${{ inputs.android_flavor5 }}" != "true" ] && \
             [ "${{ inputs.ios_flavor1 }}" != "true" ] && \
             [ "${{ inputs.ios_flavor2 }}" != "true" ] && \
             [ "${{ inputs.ios_flavor3 }}" != "true" ] && \
             [ "${{ inputs.ios_flavor4 }}" != "true" ] && \
             [ "${{ inputs.ios_flavor5 }}" != "true" ] && \
             [ "${{ inputs.web_flavor1 }}" != "true" ] && \
             [ "${{ inputs.web_flavor2 }}" != "true" ] && \
             [ "${{ inputs.web_flavor3 }}" != "true" ] && \
             [ "${{ inputs.web_flavor4 }}" != "true" ] && \
             [ "${{ inputs.web_flavor5 }}" != "true" ] && \
             [ "${{ inputs.functions }}" != "true" ] && \
             [ "${{ inputs.widgetbook }}" != "true" ]; then
            echo "âŒ No deployments selected! Please select at least one deployment option."
            exit 1
          fi
          echo "âœ… At least one deployment is selected"

  # ============================================================================
  # ANDROID DEPLOYMENT JOB
  # ============================================================================
  build-deploy-android:
    name: Android - ${{ matrix.include.name }}
    needs: prepare
    if: needs.prepare.outputs.has_android == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.android_flavors) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Debug matrix values
        run: |
          echo "ðŸ” Matrix debug:"
          echo "  matrix.include.slot: ${{ matrix.include.slot }}"
          echo "  matrix.include.name: ${{ matrix.include.name }}"

      - name: Load flavor configuration
        id: flavor-config
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/load-deploy-config@main
        with:
          flavor_name: ${{ matrix.include.name }}
          platform: android

      - name: Debug loaded config
        run: |
          echo "ðŸ” Loaded config debug:"
          echo "  target_file: ${{ steps.flavor-config.outputs.target_file }}"
          echo "  firebase_app_id: ${{ steps.flavor-config.outputs.firebase_app_id }}"
          echo "  flavor_arg: ${{ steps.flavor-config.outputs.flavor_arg }}"
          echo "  build_args: ${{ steps.flavor-config.outputs.build_args }}"

      - name: Setup SOPS and decrypt secrets
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/setup-sops@main
        with:
          sops_age_key: ${{ secrets.SOPS_AGE_KEY }}
          verify_files: "lib/firebase_options.dart,${{ steps.flavor-config.outputs.service_account }}"

      - name: Setup Flutter environment
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/setup-flutter-env@main
        with:
          flutter_version: ${{ steps.flavor-config.outputs.flutter_version }}
          flutter_channel: ${{ steps.flavor-config.outputs.flutter_channel }}
          run_analyze: "true"

      - name: Cache Gradle dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build Flutter APK
        run: |
          TARGET_FILE="${{ steps.flavor-config.outputs.target_file }}"
          FLAVOR="${{ steps.flavor-config.outputs.flavor_arg }}"
          BUILD_ARGS="${{ steps.flavor-config.outputs.build_args }}"

          echo "ðŸ” Building Flutter APK..."
          echo "ðŸ“‹ Target: $TARGET_FILE"
          echo "ðŸ“‹ Flavor: ${FLAVOR:-'(none)'}"
          
          if [ -z "$TARGET_FILE" ]; then
            echo "âŒ Target file is empty! Falling back to lib/main.dart"
            TARGET_FILE="lib/main.dart"
          fi
          
          if [ ! -f "$TARGET_FILE" ]; then
            echo "âŒ Target file \"$TARGET_FILE\" not found."
            exit 1
          fi

          BUILD_CMD="flutter build apk --release -t $TARGET_FILE"
          [ -n "$FLAVOR" ] && BUILD_CMD="$BUILD_CMD --flavor $FLAVOR"
          BUILD_CMD="$BUILD_CMD --build-name=${{ inputs.version }} $BUILD_ARGS"

          echo "ðŸš€ Running: $BUILD_CMD"
          $BUILD_CMD

          echo "âœ… APK build completed"

          # Find and set APK path
          if [ -n "$FLAVOR" ]; then
            APK_PATH="build/app/outputs/apk/$FLAVOR/release/app-$FLAVOR-release.apk"
            if [ ! -f "$APK_PATH" ]; then
              APK_PATH="build/app/outputs/flutter-apk/app-$FLAVOR-release.apk"
            fi
          else
            APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
            if [ ! -f "$APK_PATH" ]; then
              APK_PATH="build/app/outputs/apk/release/app-release.apk"
            fi
          fi

          echo "APK_OUTPUT_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "ðŸ“¦ APK path: $APK_PATH"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.include.name }}
          path: ${{ env.APK_OUTPUT_PATH }}

      - name: Setup Firebase CLI
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/setup-firebase-cli@main

      - name: Deploy to Firebase App Distribution
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/${{ steps.flavor-config.outputs.service_account }}
        run: |
          echo "ðŸš€ Deploying to Firebase App Distribution..."

          firebase appdistribution:distribute "$APK_OUTPUT_PATH" \
            --app "${{ steps.flavor-config.outputs.firebase_app_id }}" \
            --groups "${{ steps.flavor-config.outputs.groups }}" \
            --release-notes "${{ inputs.release_notes }}"

          echo "âœ… Android deployment completed"

  # ============================================================================
  # iOS DEPLOYMENT JOB
  # ============================================================================
  build-deploy-ios:
    name: iOS - ${{ matrix.include.name }}
    needs: prepare
    if: needs.prepare.outputs.has_ios == 'true'
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.ios_flavors) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Debug matrix values
        run: |
          echo "ðŸ” Matrix debug (iOS):"
          echo "  matrix.include.slot: ${{ matrix.include.slot }}"
          echo "  matrix.include.name: ${{ matrix.include.name }}"

      - name: Load flavor configuration
        id: flavor-config
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/load-deploy-config@main
        with:
          flavor_name: ${{ matrix.include.name }}
          platform: ios

      - name: Debug loaded config
        run: |
          echo "ðŸ” Loaded config debug (iOS):"
          echo "  target_file: '${{ steps.flavor-config.outputs.target_file }}'"
          echo "  firebase_app_id: '${{ steps.flavor-config.outputs.firebase_app_id }}'"
          echo "  flavor_arg: '${{ steps.flavor-config.outputs.flavor_arg }}'"
          
          if [ -z "${{ steps.flavor-config.outputs.target_file }}" ]; then
            echo "âŒ ERROR: target_file is empty!"
            exit 1
          fi

      - name: Setup SOPS and decrypt secrets (macOS)
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/setup-sops@main
        with:
          sops_age_key: ${{ secrets.SOPS_AGE_KEY }}
          verify_files: "lib/firebase_options.dart,${{ steps.flavor-config.outputs.service_account }}"
          runner_os: macos

      - name: Setup Flutter environment
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/setup-flutter-env@main
        with:
          flutter_version: ${{ steps.flavor-config.outputs.flutter_version }}
          flutter_channel: ${{ steps.flavor-config.outputs.flutter_channel }}
          run_analyze: "true"

      - name: Cache CocoaPods
        uses: actions/cache@v3
        with:
          path: |
            ios/Pods
            ios/.symlinks
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: pod install --repo-update

      - name: Build iOS
        run: |
          TARGET="${{ steps.flavor-config.outputs.target_file }}"
          FLAVOR="${{ steps.flavor-config.outputs.flavor_arg }}"
          BUILD_ARGS="${{ steps.flavor-config.outputs.build_args }}"

          echo "ðŸ” Building iOS..."
          echo "ðŸ“‹ Target: $TARGET"
          echo "ðŸ“‹ Flavor: ${FLAVOR:-'(none)'}"
          
          if [ -z "$TARGET" ]; then
            echo "âŒ Target file is empty! Falling back to lib/main.dart"
            TARGET="lib/main.dart"
          fi
          
          if [ ! -f "$TARGET" ]; then
            echo "âŒ Target file \"$TARGET\" not found."
            exit 1
          fi

          BUILD_CMD="flutter build ios --release --no-codesign --target $TARGET"
          [ -n "$FLAVOR" ] && BUILD_CMD="$BUILD_CMD --flavor $FLAVOR"
          BUILD_CMD="$BUILD_CMD --build-name=${{ inputs.version }} $BUILD_ARGS"

          echo "ðŸš€ Running: $BUILD_CMD"
          $BUILD_CMD

      - name: Setup Firebase CLI
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/setup-firebase-cli@main

      - name: Deploy to Firebase App Distribution
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/${{ steps.flavor-config.outputs.service_account }}
        run: |
          echo "ðŸš€ Deploying iOS to Firebase App Distribution..."

          APP_PATH=$(find build/ios/iphoneos -name "*.app" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "âŒ Could not find .app bundle"
            exit 1
          fi

          echo "ðŸ“¦ Found app: $APP_PATH"

          firebase appdistribution:distribute "$APP_PATH" \
            --app "${{ steps.flavor-config.outputs.firebase_app_id }}" \
            --groups "${{ steps.flavor-config.outputs.groups }}" \
            --release-notes "${{ inputs.release_notes }}"

          echo "âœ… iOS deployment completed"

  # ============================================================================
  # WEB DEPLOYMENT JOB
  # ============================================================================
  build-deploy-web:
    name: Web - ${{ matrix.include.name }}
    needs: prepare
    if: needs.prepare.outputs.has_web == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.web_flavors) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Debug matrix values
        run: |
          echo "ðŸ” Matrix debug (Web):"
          echo "  matrix.include.slot: ${{ matrix.include.slot }}"
          echo "  matrix.include.name: ${{ matrix.include.name }}"

      - name: Load flavor configuration
        id: flavor-config
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/load-deploy-config@main
        with:
          flavor_name: ${{ matrix.include.name }}
          platform: web

      - name: Debug loaded config
        run: |
          echo "ðŸ” Loaded config debug (Web):"
          echo "  target_file: '${{ steps.flavor-config.outputs.target_file }}'"
          echo "  hosting_target: '${{ steps.flavor-config.outputs.hosting_target }}'"
          echo "  deploy_only: '${{ steps.flavor-config.outputs.deploy_only }}'"
          echo "  flutter_version: '${{ steps.flavor-config.outputs.flutter_version }}'"
          
          # Validate target_file
          if [ -z "${{ steps.flavor-config.outputs.target_file }}" ]; then
            echo "âŒ ERROR: target_file is empty!"
            echo "This usually means the flavor configuration wasn't loaded correctly."
            echo "Check that .github/deploy-config.json has the flavor configured."
            exit 1
          fi

      - name: Setup SOPS and decrypt secrets
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/setup-sops@main
        with:
          sops_age_key: ${{ secrets.SOPS_AGE_KEY }}
          verify_files: "lib/firebase_options.dart,${{ steps.flavor-config.outputs.service_account }}"

      - name: Setup Flutter environment
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/setup-flutter-env@main
        with:
          flutter_version: ${{ steps.flavor-config.outputs.flutter_version }}
          flutter_channel: ${{ steps.flavor-config.outputs.flutter_channel }}
          run_analyze: "true"

      - name: Build and install functions (if needed)
        if: steps.flavor-config.outputs.build_functions == 'true'
        run: |
          FUNCTIONS_PATH="${{ steps.flavor-config.outputs.functions_path }}"
          echo "ðŸ“¦ Installing and building functions in $FUNCTIONS_PATH..."

          cd "$FUNCTIONS_PATH"
          npm install

          # Handle biome binary permissions
          if [ -f "node_modules/@biomejs/cli-linux-x64/biome" ]; then
            chmod +x node_modules/@biomejs/cli-linux-x64/biome
          fi

          npm run build
          cd ..
          echo "âœ… Functions built successfully"

      - name: Build Flutter Web
        run: |
          TARGET_FILE="${{ steps.flavor-config.outputs.target_file }}"
          BUILD_ARGS="${{ steps.flavor-config.outputs.build_args }}"

          echo "ðŸ” Building Flutter Web..."
          echo "ðŸ“‹ Target: $TARGET_FILE"
          
          if [ -z "$TARGET_FILE" ]; then
            echo "âŒ Target file is empty! Falling back to lib/main.dart"
            TARGET_FILE="lib/main.dart"
          fi
          
          if [ ! -f "$TARGET_FILE" ]; then
            echo "âŒ Target file \"$TARGET_FILE\" not found."
            exit 1
          fi
          
          flutter build web --release -t "$TARGET_FILE" $BUILD_ARGS
          echo "âœ… Web build completed"

      - name: Setup Firebase CLI
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/setup-firebase-cli@main

      - name: Deploy to Firebase Hosting
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/${{ steps.flavor-config.outputs.service_account }}
        run: |
          FIREBASE_PROJECT="${{ steps.flavor-config.outputs.firebase_project }}"
          HOSTING_TARGET="${{ steps.flavor-config.outputs.hosting_target }}"
          DEPLOY_ONLY="${{ steps.flavor-config.outputs.deploy_only }}"

          echo "ðŸš€ Deploying to Firebase Hosting..."

          if [ -n "$DEPLOY_ONLY" ]; then
            firebase deploy --only "$DEPLOY_ONLY" --project "$FIREBASE_PROJECT" --non-interactive
          elif [ -n "$HOSTING_TARGET" ]; then
            firebase deploy --only "hosting:$HOSTING_TARGET" --project "$FIREBASE_PROJECT" --non-interactive
          else
            firebase deploy --only hosting --project "$FIREBASE_PROJECT" --non-interactive
          fi

          echo "âœ… Web deployment completed"

  # ============================================================================
  # FUNCTIONS DEPLOYMENT JOB
  # ============================================================================
  deploy-functions:
    name: Deploy Functions
    needs: prepare
    if: needs.prepare.outputs.has_functions == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Load configuration
        id: config
        run: |
          CONFIG_FILE=".github/deploy-config.json"

          FIREBASE_PROJECT=$(jq -r ".firebase.project_id // empty" "$CONFIG_FILE")
          SERVICE_ACCOUNT=$(jq -r ".firebase.service_account_path // \"firebase_service_account.json\"" "$CONFIG_FILE")
          FUNCTIONS_PATH=$(jq -r ".functions.path // \"functions\"" "$CONFIG_FILE")
          INSTALL_CMD=$(jq -r ".functions.install_command // \"npm install\"" "$CONFIG_FILE")
          BUILD_CMD=$(jq -r ".functions.build_command // \"npm run build\"" "$CONFIG_FILE")
          CHMOD_BIOME=$(jq -r ".functions.chmod_biome // false" "$CONFIG_FILE")

          echo "firebase_project=$FIREBASE_PROJECT" >> $GITHUB_OUTPUT
          echo "service_account=$SERVICE_ACCOUNT" >> $GITHUB_OUTPUT
          echo "functions_path=$FUNCTIONS_PATH" >> $GITHUB_OUTPUT
          echo "install_cmd=$INSTALL_CMD" >> $GITHUB_OUTPUT
          echo "build_cmd=$BUILD_CMD" >> $GITHUB_OUTPUT
          echo "chmod_biome=$CHMOD_BIOME" >> $GITHUB_OUTPUT

      - name: Setup SOPS and decrypt secrets
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/setup-sops@main
        with:
          sops_age_key: ${{ secrets.SOPS_AGE_KEY }}
          verify_files: "${{ steps.config.outputs.service_account }}"

      - name: Setup Firebase CLI
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/setup-firebase-cli@main

      - name: Install and build functions
        working-directory: ${{ steps.config.outputs.functions_path }}
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          ${{ steps.config.outputs.install_cmd }}

          if [ "${{ steps.config.outputs.chmod_biome }}" = "true" ]; then
            if [ -f "node_modules/@biomejs/cli-linux-x64/biome" ]; then
              chmod +x node_modules/@biomejs/cli-linux-x64/biome
            fi
          fi

          echo "ðŸ”¨ Building functions..."
          ${{ steps.config.outputs.build_cmd }}

      - name: Deploy functions to Firebase
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/${{ steps.config.outputs.service_account }}
        run: |
          echo "ðŸš€ Deploying functions..."
          firebase deploy --only functions --project ${{ steps.config.outputs.firebase_project }} --non-interactive
          echo "âœ… Functions deployment completed"

  # ============================================================================
  # WIDGETBOOK DEPLOYMENT JOB
  # ============================================================================
  deploy-widgetbook:
    name: Deploy Widgetbook
    needs: prepare
    if: needs.prepare.outputs.has_widgetbook == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Load configuration
        id: config
        run: |
          CONFIG_FILE=".github/deploy-config.json"

          FIREBASE_PROJECT=$(jq -r ".firebase.project_id // empty" "$CONFIG_FILE")
          SERVICE_ACCOUNT=$(jq -r ".firebase.service_account_path // \"firebase_service_account.json\"" "$CONFIG_FILE")
          WIDGETBOOK_DIR=$(jq -r ".widgetbook.directory // \"widgetbook\"" "$CONFIG_FILE")
          HOSTING_TARGET=$(jq -r ".widgetbook.hosting_target // \"widgetbook\"" "$CONFIG_FILE")
          FLUTTER_VERSION=$(jq -r ".flutter_version // \"3.38.4\"" "$CONFIG_FILE")
          FLUTTER_CHANNEL=$(jq -r ".flutter_channel // \"stable\"" "$CONFIG_FILE")

          echo "firebase_project=$FIREBASE_PROJECT" >> $GITHUB_OUTPUT
          echo "service_account=$SERVICE_ACCOUNT" >> $GITHUB_OUTPUT
          echo "widgetbook_dir=$WIDGETBOOK_DIR" >> $GITHUB_OUTPUT
          echo "hosting_target=$HOSTING_TARGET" >> $GITHUB_OUTPUT
          echo "flutter_version=$FLUTTER_VERSION" >> $GITHUB_OUTPUT
          echo "flutter_channel=$FLUTTER_CHANNEL" >> $GITHUB_OUTPUT

      - name: Setup SOPS and decrypt secrets
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/setup-sops@main
        with:
          sops_age_key: ${{ secrets.SOPS_AGE_KEY }}
          verify_files: "${{ steps.config.outputs.service_account }}"

      - name: Setup Flutter environment
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/setup-flutter-env@main
        with:
          flutter_version: ${{ steps.config.outputs.flutter_version }}
          flutter_channel: ${{ steps.config.outputs.flutter_channel }}

      - name: Get Widgetbook dependencies
        working-directory: ${{ steps.config.outputs.widgetbook_dir }}
        run: flutter pub get

      - name: Run build_runner
        working-directory: ${{ steps.config.outputs.widgetbook_dir }}
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Widgetbook
        working-directory: ${{ steps.config.outputs.widgetbook_dir }}
        run: flutter build web

      - name: Setup Firebase CLI
        uses: Anyhoosolutions/flutter_platform_kit/tools/github_actions/manual_full_deploy/actions/setup-firebase-cli@main

      - name: Deploy Widgetbook
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/${{ steps.config.outputs.service_account }}
        run: |
          echo "ðŸš€ Deploying Widgetbook..."
          firebase deploy --only "hosting:${{ steps.config.outputs.hosting_target }}" \
            --project ${{ steps.config.outputs.firebase_project }} --non-interactive
          echo "âœ… Widgetbook deployment completed"

  # ============================================================================
  # SUMMARY JOB
  # ============================================================================
  summary:
    name: Deployment Summary
    needs:
      [
        prepare,
        build-deploy-android,
        build-deploy-ios,
        build-deploy-web,
        deploy-functions,
        deploy-widgetbook,
      ]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate deployment summary
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ref:** ${{ needs.prepare.outputs.checkout_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY

          # Check each job result
          if [ "${{ needs.prepare.outputs.has_android }}" = "true" ]; then
            if [ "${{ needs.build-deploy-android.result }}" = "success" ]; then
              echo "| Android | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.build-deploy-android.result }}" = "failure" ]; then
              echo "| Android | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Android | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [ "${{ needs.prepare.outputs.has_ios }}" = "true" ]; then
            if [ "${{ needs.build-deploy-ios.result }}" = "success" ]; then
              echo "| iOS | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.build-deploy-ios.result }}" = "failure" ]; then
              echo "| iOS | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| iOS | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [ "${{ needs.prepare.outputs.has_web }}" = "true" ]; then
            if [ "${{ needs.build-deploy-web.result }}" = "success" ]; then
              echo "| Web | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.build-deploy-web.result }}" = "failure" ]; then
              echo "| Web | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Web | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [ "${{ needs.prepare.outputs.has_functions }}" = "true" ]; then
            if [ "${{ needs.deploy-functions.result }}" = "success" ]; then
              echo "| Functions | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.deploy-functions.result }}" = "failure" ]; then
              echo "| Functions | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Functions | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [ "${{ needs.prepare.outputs.has_widgetbook }}" = "true" ]; then
            if [ "${{ needs.deploy-widgetbook.result }}" = "success" ]; then
              echo "| Widgetbook | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.deploy-widgetbook.result }}" = "failure" ]; then
              echo "| Widgetbook | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Widgetbook | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*" >> $GITHUB_STEP_SUMMARY
