name: Upload docs

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

env:
  # Setting an environment variable with the value of a configuration variable
  UPLOAD_URL: ${{ vars.UPLOAD_URL }}

jobs:
  run-main:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare documentation
        uses: ./.github/actions/prepare-docs

      - name: Upload documentation
        uses: ./tools/upload-docs-action
        with:
          upload_url: ${{ vars.UPLOAD_URL }}
          dart_sdk: "3.5"
          commit_hash: ""

  run-non-main:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref != 'refs/heads/main')
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for version in pubspec.yaml
        run: |
          failed=false
          for package_dir in packages/*/ tools/*/; do
            package_name=$(basename "$package_dir")
            
            if [ ! -f "$package_dir/pubspec.yaml" ] || [ ! -f "$package_dir/CHANGELOG.md" ]; then
              continue
            fi
            
            pubspec_version=$(cat "$package_dir/pubspec.yaml" | grep "version:" | awk '{print $2}')
            changelog_version=$(cat "$package_dir/CHANGELOG.md" | grep "## " | head -n 1 | awk '{print $2}')

            
            if [ "$pubspec_version" != "$changelog_version" ]; then
              echo "❌ Error: The version in the pubspec.yaml does not match the version in the CHANGELOG.md"
              echo "   Package: $package_name, Version: $pubspec_version, Changelog Version: $changelog_version"
              failed=true
            fi
          done

          if [ "$failed" = true ]; then
            echo "❌ Error: Some version mismatch detected"
            exit 1
          fi

      - name: Verify CHANGELOGs have been updated
        if: github.event_name == 'pull_request'
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"

          # Fetch the base branch to compare against
          git fetch origin $BASE_REF

          # Check which packages have been modified
          CHANGED_PACKAGES=$(git diff --name-only origin/$BASE_REF...HEAD | grep -E '^packages/[^/]+/' | cut -d'/' -f2 | sort -u)

          # Check if any tools have been modified
          CHANGED_TOOLS=$(git diff --name-only origin/$BASE_REF...HEAD | grep -E '^tools/[^/]+/' | cut -d'/' -f2 | sort -u)
          HAS_CHANGES=false
          if [ -n "$CHANGED_PACKAGES" ]; then
            HAS_CHANGES=true
          fi
          if [ -n "$CHANGED_TOOLS" ]; then
            if [ -n "$CHANGED_PACKAGES" ]; then
              CHANGED_PACKAGES="$CHANGED_PACKAGES $CHANGED_TOOLS"
            else
              CHANGED_PACKAGES="$CHANGED_TOOLS"
            fi
            HAS_CHANGES=true
          fi

          MISSING_CHANGELOGS=()

          # For each modified package, check if its CHANGELOG was updated
          for package in $CHANGED_PACKAGES; do
            # Check if it's a tool (exists in tools directory)
            if [ -d "tools/$package" ]; then
              CHANGELOG_PATH="tools/$package/CHANGELOG.md"
            else
              CHANGELOG_PATH="packages/$package/CHANGELOG.md"
            fi
            
            # Skip if package doesn't have a CHANGELOG
            if [ ! -f "$CHANGELOG_PATH" ]; then
              continue
            fi
            
            # Check if CHANGELOG was modified
            if git diff --quiet origin/$BASE_REF...HEAD -- "$CHANGELOG_PATH"; then
              MISSING_CHANGELOGS+=("$package")
            else
              echo "✅ $CHANGELOG_PATH has been updated"
            fi
          done

          # Fail if any package's CHANGELOG wasn't updated
          if [ ${#MISSING_CHANGELOGS[@]} -gt 0 ]; then
            echo "❌ Error: The following packages have changes but their CHANGELOG.md files have not been updated:"
            for package in "${MISSING_CHANGELOGS[@]}"; do
              # Check if it's a tool (exists in tools directory)
              if [ -d "tools/$package" ]; then
                echo "   - tools/$package/CHANGELOG.md"
              else
                echo "   - packages/$package/CHANGELOG.md"
              fi
            done
            echo "Please update the CHANGELOG.md files before submitting the PR."
            exit 1
          fi

          if [ "$HAS_CHANGES" = false ]; then
            echo "ℹ️  No package changes detected, skipping CHANGELOG verification"
          fi

      - name: Prepare documentation
        if: github.event_name == 'pull_request'
        uses: ./tools/prepare-docs-action

      - name: Upload documentation
        uses: ./tools/upload-docs-action
        with:
          upload_url: ${{ vars.UPLOAD_URL }}
          dart_sdk: "3.5"
          commit_hash: ${{ github.sha }}
          pr_docs_base_url: "https://anyhoosolutions.web.app/documentation"
