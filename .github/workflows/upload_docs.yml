name: Upload docs

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

env:
  # Setting an environment variable with the value of a configuration variable
  UPLOAD_URL: ${{ vars.UPLOAD_URL }}

jobs:
  run-main:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: "3.5"

      - name: Generate toc.json
        run: |
          cd scripts/console
          dart pub get --no-precompile
          dart bin/generate_toc.dart
          cd ../..
          cat docs/toc.json

      - name: Copy CHANGELOGs to docs
        run: |
          # Copy each package's CHANGELOG.md to docs/{package_name}/CHANGELOG.md
          for package_dir in packages/*/ tools/*/; do
            package_name=$(basename "$package_dir")
            changelog_path="$package_dir/CHANGELOG.md"
            
            if [ -f "$changelog_path" ]; then
              mkdir -p "docs/$package_name"
              cp "$changelog_path" "docs/$package_name/CHANGELOG.md"
              echo "✅ Copied $package_name/CHANGELOG.md to docs/$package_name/CHANGELOG.md"
            else
              echo "⚠️  No CHANGELOG.md found for $package_name"
            fi
          done

      - name: Copy READMEs to docs
        run: |
          # Copy each package's README.md to docs/{package_name}/README.md
          for package_dir in packages/*/ tools/*/; do
            package_name=$(basename "$package_dir")
            readme_path="$package_dir/README.md"
            
            if [ -f "$readme_path" ]; then
              mkdir -p "docs/$package_name"
              cp "$readme_path" "docs/$package_name/README.md"
              echo "✅ Copied $package_name/README.md to docs/$package_name/README.md"
            else
              echo "⚠️  No README.md found for $package_name"
            fi
          done

      - name: Copy package docs directories
        run: |
          # Copy all files from each package's docs/ directory to docs/{package_name}/
          for package_dir in packages/*/ tools/*/; do
            package_name=$(basename "$package_dir")
            docs_dir="$package_dir/docs"
            
            if [ -d "$docs_dir" ]; then
              mkdir -p "docs/$package_name"
              # Copy all files from the package's docs directory, preserving structure
              find "$docs_dir" -type f -name "*.md" | while read -r doc_file; do
                # Get relative path from docs_dir
                rel_path="${doc_file#$docs_dir/}"
                target_dir="docs/$package_name/$(dirname "$rel_path")"
                mkdir -p "$target_dir"
                cp "$doc_file" "docs/$package_name/$rel_path"
                echo "✅ Copied $package_name/docs/$rel_path to docs/$package_name/$rel_path"
              done
            else
              echo "ℹ️  No docs/ directory found for $package_name"
            fi
          done

      - name: Copy additional documentation files from package root
        run: |
          # Copy any additional .md files from package root (excluding README.md and CHANGELOG.md)
          for package_dir in packages/*/ tools/*/; do
            package_name=$(basename "$package_dir")
            
            # Find all .md files in package root that aren't README.md or CHANGELOG.md
            find "$package_dir" -maxdepth 1 -type f -name "*.md" ! -name "README.md" ! -name "CHANGELOG.md" | while read -r doc_file; do
              filename=$(basename "$doc_file")
              mkdir -p "docs/$package_name"
              cp "$doc_file" "docs/$package_name/$filename"
              echo "✅ Copied $package_name/$filename to docs/$package_name/$filename"
            done
          done

      - name: Set up Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: "3.5"

      - name: Cache Dart packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-dart-${{ hashFiles('**/pubspec.yaml') }}

      - name: Run main deployment
        run: |
          cd scripts/console
          dart pub get --no-precompile
          echo $UPLOAD_URL
          dart bin/console.dart

  run-non-main:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref != 'refs/heads/main')
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for version in pubspec.yaml
        run: |
          failed=false
          for package_dir in packages/*/ tools/*/; do
            package_name=$(basename "$package_dir")
            
            if [ ! -f "$package_dir/pubspec.yaml" ] || [ ! -f "$package_dir/CHANGELOG.md" ]; then
              continue
            fi
            
            pubspec_version=$(cat "$package_dir/pubspec.yaml" | grep "version:" | awk '{print $2}')
            changelog_version=$(cat "$package_dir/CHANGELOG.md" | grep "## " | head -n 1 | awk '{print $2}')

            
            if [ "$pubspec_version" != "$changelog_version" ]; then
              echo "❌ Error: The version in the pubspec.yaml does not match the version in the CHANGELOG.md"
              echo "   Package: $package_name, Version: $pubspec_version, Changelog Version: $changelog_version"
              failed=true
            fi
          done

          if [ "$failed" = true ]; then
            echo "❌ Error: Some version mismatch detected"
            exit 1
          fi

      - name: Verify CHANGELOGs have been updated
        if: github.event_name == 'pull_request'
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"

          # Fetch the base branch to compare against
          git fetch origin $BASE_REF

          # Check which packages have been modified
          CHANGED_PACKAGES=$(git diff --name-only origin/$BASE_REF...HEAD | grep -E '^packages/[^/]+/' | cut -d'/' -f2 | sort -u)

          # Check if any tools have been modified
          CHANGED_TOOLS=$(git diff --name-only origin/$BASE_REF...HEAD | grep -E '^tools/[^/]+/' | cut -d'/' -f2 | sort -u)
          HAS_CHANGES=false
          if [ -n "$CHANGED_PACKAGES" ]; then
            HAS_CHANGES=true
          fi
          if [ -n "$CHANGED_TOOLS" ]; then
            if [ -n "$CHANGED_PACKAGES" ]; then
              CHANGED_PACKAGES="$CHANGED_PACKAGES $CHANGED_TOOLS"
            else
              CHANGED_PACKAGES="$CHANGED_TOOLS"
            fi
            HAS_CHANGES=true
          fi

          MISSING_CHANGELOGS=()

          # For each modified package, check if its CHANGELOG was updated
          for package in $CHANGED_PACKAGES; do
            # Check if it's a tool (exists in tools directory)
            if [ -d "tools/$package" ]; then
              CHANGELOG_PATH="tools/$package/CHANGELOG.md"
            else
              CHANGELOG_PATH="packages/$package/CHANGELOG.md"
            fi
            
            # Skip if package doesn't have a CHANGELOG
            if [ ! -f "$CHANGELOG_PATH" ]; then
              continue
            fi
            
            # Check if CHANGELOG was modified
            if git diff --quiet origin/$BASE_REF...HEAD -- "$CHANGELOG_PATH"; then
              MISSING_CHANGELOGS+=("$package")
            else
              echo "✅ $CHANGELOG_PATH has been updated"
            fi
          done

          # Fail if any package's CHANGELOG wasn't updated
          if [ ${#MISSING_CHANGELOGS[@]} -gt 0 ]; then
            echo "❌ Error: The following packages have changes but their CHANGELOG.md files have not been updated:"
            for package in "${MISSING_CHANGELOGS[@]}"; do
              # Check if it's a tool (exists in tools directory)
              if [ -d "tools/$package" ]; then
                echo "   - tools/$package/CHANGELOG.md"
              else
                echo "   - packages/$package/CHANGELOG.md"
              fi
            done
            echo "Please update the CHANGELOG.md files before submitting the PR."
            exit 1
          fi

          if [ "$HAS_CHANGES" = false ]; then
            echo "ℹ️  No package changes detected, skipping CHANGELOG verification"
          fi

      - name: Set up Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: "3.5"

      - name: Generate toc.json
        if: github.event_name == 'pull_request'
        run: |
          cd scripts/console
          dart pub get --no-precompile
          dart bin/generate_toc.dart
          cd ../..
          cat docs/toc.json

      - name: Copy CHANGELOGs to docs
        if: github.event_name == 'pull_request'
        run: |
          # Copy each package's CHANGELOG.md to docs/{package_name}/CHANGELOG.md
          for package_dir in packages/*/ tools/*/; do
            package_name=$(basename "$package_dir")
            changelog_path="$package_dir/CHANGELOG.md"
            
            if [ -f "$changelog_path" ]; then
              mkdir -p "docs/$package_name"
              cp "$changelog_path" "docs/$package_name/CHANGELOG.md"
              echo "✅ Copied $package_name/CHANGELOG.md to docs/$package_name/CHANGELOG.md"
            else
              echo "⚠️  No CHANGELOG.md found for $package_name"
            fi
          done

      - name: Copy READMEs to docs
        if: github.event_name == 'pull_request'
        run: |
          # Copy each package's README.md to docs/{package_name}/README.md
          for package_dir in packages/*/ tools/*/; do
            package_name=$(basename "$package_dir")
            readme_path="$package_dir/README.md"
            
            if [ -f "$readme_path" ]; then
              mkdir -p "docs/$package_name"
              cp "$readme_path" "docs/$package_name/README.md"
              echo "✅ Copied $package_name/README.md to docs/$package_name/README.md"
            else
              echo "⚠️  No README.md found for $package_name"
            fi
          done

      - name: Copy package docs directories
        if: github.event_name == 'pull_request'
        run: |
          # Copy all files from each package's docs/ directory to docs/{package_name}/
          for package_dir in packages/*/ tools/*/; do
            package_name=$(basename "$package_dir")
            docs_dir="$package_dir/docs"
            
            if [ -d "$docs_dir" ]; then
              mkdir -p "docs/$package_name"
              # Copy all files from the package's docs directory, preserving structure
              find "$docs_dir" -type f -name "*.md" | while read -r doc_file; do
                # Get relative path from docs_dir
                rel_path="${doc_file#$docs_dir/}"
                target_dir="docs/$package_name/$(dirname "$rel_path")"
                mkdir -p "$target_dir"
                cp "$doc_file" "docs/$package_name/$rel_path"
                echo "✅ Copied $package_name/docs/$rel_path to docs/$package_name/$rel_path"
              done
            else
              echo "ℹ️  No docs/ directory found for $package_name"
            fi
          done

      - name: Copy additional documentation files from package root
        if: github.event_name == 'pull_request'
        run: |
          # Copy any additional .md files from package root (excluding README.md and CHANGELOG.md)
          for package_dir in packages/*/ tools/*/; do
            package_name=$(basename "$package_dir")
            
            # Find all .md files in package root that aren't README.md or CHANGELOG.md
            find "$package_dir" -maxdepth 1 -type f -name "*.md" ! -name "README.md" ! -name "CHANGELOG.md" | while read -r doc_file; do
              filename=$(basename "$doc_file")
              mkdir -p "docs/$package_name"
              cp "$doc_file" "docs/$package_name/$filename"
              echo "✅ Copied $package_name/$filename to docs/$package_name/$filename"
            done
          done

      - name: Set up Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: "3.5"

      - name: Cache Dart packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-dart-${{ hashFiles('**/pubspec.yaml') }}

      - name: Run non-main deployment
        run: |
          cd scripts/console
          dart pub get --no-precompile
          export GIT_COMMIT_HASH=$(git rev-parse HEAD)
          echo $UPLOAD_URL
          dart bin/console.dart --commitHash=$GIT_COMMIT_HASH

      - name: Build PR docs link
        if: github.event_name == 'pull_request'
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          PR_DOCS_URL="https://anyhoosolutions.web.app/documentation/$COMMIT_HASH"
          echo "pr_docs_link=$PR_DOCS_URL" >> $GITHUB_ENV
          echo "PR Documentation URL: $PR_DOCS_URL"

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ${{ env.pr_docs_link }}
